name: Comprehensive SCA for Go Application
on:
  workflow_dispatch:
  workflow_call:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  sca:
    runs-on: ubuntu-latest
    name: Comprehensive Security Scan
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        
      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.24.2'
          
      - name: Download all dependencies
        run: |
          go mod download
          go mod tidy
          go mod verify
          
      - name: List all dependencies (including transitive)
        run: |
          echo "=== All dependencies (direct and transitive) ==="
          go list -m all
          echo ""
          echo "=== Vulnerable dependencies reported by Dependabot ==="
          go list -m all | grep -E "(golang.org/x/net|github.com/gin-gonic/gin|google.golang.org/grpc)" || true
          
      - name: Run Govulncheck (Official Go vulnerability scanner)
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck -json ./... > govulncheck-results.json || true
          
      - name: Run Snyk with deeper scanning
        uses: snyk/actions/golang@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --all-projects --severity-threshold=low --sarif-file-output=snyk.sarif
          
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          
      - name: Upload Snyk results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: snyk.sarif
          
      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-results.sarif

  dependabot-audit:
    runs-on: ubuntu-latest
    name: Verify Dependabot Findings
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        
      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.24.2'
          
      - name: Check specific vulnerable dependencies
        run: |
          echo "=== Checking versions of vulnerable dependencies ==="
          
          # Check current versions
          echo "Current versions:"
          go list -m golang.org/x/net 2>/dev/null || echo "golang.org/x/net not found in direct dependencies"
          go list -m github.com/gin-gonic/gin 2>/dev/null || echo "gin-gonic/gin not found in direct dependencies"
          go list -m google.golang.org/grpc 2>/dev/null || echo "grpc not found in direct dependencies"
          
          echo ""
          echo "=== Checking if vulnerable via go mod graph ==="
          go mod graph | grep -E "(golang.org/x/net|gin-gonic/gin|google.golang.org/grpc)" | head -10