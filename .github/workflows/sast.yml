name: 40 SAST

on:
  workflow_dispatch:
  workflow_call:
# Permissions for workflow_call - inherited from caller
permissions:
  actions: read
  contents: read
  security-events: write

jobs:
  semgrep:
    name: SAST Semgrep
    runs-on: ubuntu-latest
    container:
      # A Docker image with Semgrep installed. Do not change this.
      image: returntocorp/semgrep

    # To skip any PR created by dependabot to avoid permission issues:
    if: (github.actor != 'dependabot[bot]')

    steps:
      # Fetch project source with GitHub Actions Checkout.
      - uses: actions/checkout@v5
      
      - name: Run Semgrep
        run: semgrep ci -v -o results.sarif --sarif || true
        env:
           # Add the rules that Semgrep uses by setting the SEMGREP_RULES environment variable. 
           # Using Go-specific and general security rules
           SEMGREP_RULES: p/default p/security-audit p/golang p/cwe-top-25 p/owasp-top-ten
           # more at semgrep.dev/explore
           # Uncomment SEMGREP_TIMEOUT to set this job's timeout (in seconds): Default timeout is 1800 seconds (30 minutes). 0=disable
           # SEMGREP_TIMEOUT: 300
      
      - name: Upload Semgrep Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: semgrep.sarif
          path: results.sarif
          retention-days: 30
      
      - name: Upload analysis results to GitHub Security tab
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif
          category: semgrep

      - name: Generate summary
        if: always()
        run: |
          echo "## ðŸ” SAST Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Semgrep Security Analysis" >> $GITHUB_STEP_SUMMARY
          echo "Pattern-based security scanner for Go applications" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Rulesets Applied:**" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”’ **p/default**: General security patterns" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” **p/security-audit**: Security audit rules" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ¹ **p/golang**: Go-specific security patterns" >> $GITHUB_STEP_SUMMARY
          echo "- âš ï¸ **p/cwe-top-25**: CWE Top 25 Most Dangerous Weaknesses" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ›¡ï¸ **p/owasp-top-ten**: OWASP Top 10 Security Risks" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "results.sarif" ]; then
            FINDINGS=$(cat results.sarif | jq '.runs[0].results | length' 2>/dev/null || echo "0")
            if [ "$FINDINGS" -eq "0" ]; then
              echo "âœ… **No security issues found!**" >> $GITHUB_STEP_SUMMARY
            else
              echo "âš ï¸ **Found $FINDINGS potential security issue(s)**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "ðŸ“Š View detailed results in the **Security** tab under **Code Scanning**" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ No SARIF report generated" >> $GITHUB_STEP_SUMMARY
          fi