name: 10 Build pipeline
on:
  workflow_dispatch:
  workflow_call:
jobs:
  build:
    permissions:
      contents: read
      issues: read
      checks: write
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21.x'
        cache: true
    
    - name: Install dependencies
      run: go get .
    
    # Build the Go application
    - name: Build with Go
      run: go build -v ./...
    
    - name: Create binary artifact directory
      run: |
        mkdir candidate-binary
        # Copy any built executables
        find . -maxdepth 1 -type f -executable ! -name ".*" -exec cp {} candidate-binary/ \; 2>/dev/null || true
    
    # Test with Go and convert to JUnit XML
    - name: Install go-junit-report
      run: go install github.com/jstemmer/go-junit-report/v2@latest
    
    - name: Test with Go
      run: |
        go test -v ./... 2>&1 | tee test-output.txt
        cat test-output.txt | go-junit-report -set-exit-code > test-results.xml
      continue-on-error: true
    
    - name: Create test results directory
      run: mkdir test-results && mv test-results.xml test-results/
    
    - uses: actions/upload-artifact@v3
      with:
        name: Application-Binary
        path: candidate-binary
    
    - uses: actions/upload-artifact@v3
      with:
        name: Test-Results
        path: test-results
    
    - name: Publish Test Results
      uses: EnricoMi/publish-unit-test-result-action@v2
      if: always()
      with:
        files: "test-results/**/*.xml"