name: Deploy to Amazon ECS

on:
  push:
    branches:
      - main
      - prod

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: ecr-repo-ecs-tf-project
  AWS_ACCOUNT_ID: 651706742043

jobs:
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.set-tag.outputs.tag }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set image tag
        id: set-tag
        run: echo "tag=${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ steps.set-tag.outputs.tag }}
        run: |
          # Build the Docker image
          docker buildx build \
            --platform "linux/amd64" \
            --tag "$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" \
            --load \
            .
          
          # Push to ECR
          docker push "$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
          
          echo "✅ Image pushed: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main'
    environment: staging
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set deployment variables
        id: vars
        run: |
          echo "cluster=staging" >> $GITHUB_OUTPUT
          echo "service=staging-service" >> $GITHUB_OUTPUT
          echo "task-family=staging-service" >> $GITHUB_OUTPUT

      - name: Pull Docker image
        env:
          IMAGE_TAG: ${{ needs.build-and-push.outputs.image-tag }}
        run: |
          docker pull ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY }}:$IMAGE_TAG

      - name: Run database migrations
        env:
          IMAGE_TAG: ${{ needs.build-and-push.outputs.image-tag }}
          CLUSTER_NAME: ${{ steps.vars.outputs.cluster }}
          SERVICE_NAME: ${{ steps.vars.outputs.service }}
        run: |
          # Create container overrides for migration
          cat > overrides.json <<EOF
          {
            "containerOverrides": [
              {
                "name": "service",
                "command": ["goose", "-dir", "migrations", "up"]
              }
            ]
          }
          EOF
          
          # Run migration task
          echo "Starting migration task..."
          TASK_ARN=$(aws ecs run-task \
            --cluster "${CLUSTER_NAME}" \
            --task-definition "${SERVICE_NAME}" \
            --launch-type EC2 \
            --overrides file://overrides.json \
            --query 'tasks[0].taskArn' \
            --output text)
          
          echo "Migration task ARN: ${TASK_ARN}"
          
          # Wait for task to complete
          echo "Waiting for migration task to complete..."
          aws ecs wait tasks-stopped \
            --cluster "${CLUSTER_NAME}" \
            --tasks "${TASK_ARN}"
          
          # Check exit code
          EXIT_CODE=$(aws ecs describe-tasks \
            --cluster "${CLUSTER_NAME}" \
            --tasks "${TASK_ARN}" \
            --query 'tasks[0].containers[0].exitCode' \
            --output text)
          
          if [ "$EXIT_CODE" != "0" ]; then
            echo "❌ Migration failed with exit code: ${EXIT_CODE}"
            
            # Get logs for debugging
            LOG_STREAM=$(aws ecs describe-tasks \
              --cluster "${CLUSTER_NAME}" \
              --tasks "${TASK_ARN}" \
              --query 'tasks[0].containers[0].name' \
              --output text)
            
            echo "Check CloudWatch logs for details: /aws/ecs/${CLUSTER_NAME}/${LOG_STREAM}"
            exit 1
          fi
          
          echo "✅ Migrations completed successfully"

      - name: Promote image tag
        env:
          IMAGE_TAG: ${{ needs.build-and-push.outputs.image-tag }}
        run: |
          # Tag the image as 'staging'
          docker pull ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY }}:$IMAGE_TAG
          docker tag \
            ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY }}:$IMAGE_TAG \
            ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY }}:staging
          docker push ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY }}:staging

      - name: Deploy to ECS
        env:
          CLUSTER_NAME: ${{ steps.vars.outputs.cluster }}
          SERVICE_NAME: ${{ steps.vars.outputs.service }}
        run: |
          echo "Updating ECS service: ${SERVICE_NAME}"
          
          aws ecs update-service \
            --cluster "${CLUSTER_NAME}" \
            --service "${SERVICE_NAME}" \
            --force-new-deployment \
            --query 'service.serviceName' \
            --output text
          
          echo "Waiting for service to stabilize..."
          aws ecs wait services-stable \
            --cluster "${CLUSTER_NAME}" \
            --services "${SERVICE_NAME}"
          
          echo "✅ Deployment completed successfully"

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/prod'
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set deployment variables
        id: vars
        run: |
          echo "cluster=prod" >> $GITHUB_OUTPUT
          echo "service=prod-service" >> $GITHUB_OUTPUT
          echo "task-family=prod-service" >> $GITHUB_OUTPUT

      - name: Pull Docker image
        env:
          IMAGE_TAG: ${{ needs.build-and-push.outputs.image-tag }}
        run: |
          docker pull ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY }}:$IMAGE_TAG

      - name: Run database migrations
        env:
          IMAGE_TAG: ${{ needs.build-and-push.outputs.image-tag }}
          CLUSTER_NAME: ${{ steps.vars.outputs.cluster }}
          SERVICE_NAME: ${{ steps.vars.outputs.service }}
        run: |
          # Create container overrides for migration
          cat > overrides.json <<EOF
          {
            "containerOverrides": [
              {
                "name": "service",
                "command": ["goose", "-dir", "migrations", "up"]
              }
            ]
          }
          EOF
          
          # Run migration task
          echo "Starting migration task..."
          TASK_ARN=$(aws ecs run-task \
            --cluster "${CLUSTER_NAME}" \
            --task-definition "${SERVICE_NAME}" \
            --launch-type EC2 \
            --overrides file://overrides.json \
            --query 'tasks[0].taskArn' \
            --output text)
          
          echo "Migration task ARN: ${TASK_ARN}"
          
          # Wait for task to complete
          echo "Waiting for migration task to complete..."
          aws ecs wait tasks-stopped \
            --cluster "${CLUSTER_NAME}" \
            --tasks "${TASK_ARN}"
          
          # Check exit code
          EXIT_CODE=$(aws ecs describe-tasks \
            --cluster "${CLUSTER_NAME}" \
            --tasks "${TASK_ARN}" \
            --query 'tasks[0].containers[0].exitCode' \
            --output text)
          
          if [ "$EXIT_CODE" != "0" ]; then
            echo "❌ Migration failed with exit code: ${EXIT_CODE}"
            exit 1
          fi
          
          echo "✅ Migrations completed successfully"

      - name: Promote image tag
        env:
          IMAGE_TAG: ${{ needs.build-and-push.outputs.image-tag }}
        run: |
          # Tag the image as 'prod'
          docker pull ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY }}:$IMAGE_TAG
          docker tag \
            ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY }}:$IMAGE_TAG \
            ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY }}:prod
          docker push ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY }}:prod

      - name: Deploy to ECS
        env:
          CLUSTER_NAME: ${{ steps.vars.outputs.cluster }}
          SERVICE_NAME: ${{ steps.vars.outputs.service }}
        run: |
          echo "Updating ECS service: ${SERVICE_NAME}"
          
          aws ecs update-service \
            --cluster "${CLUSTER_NAME}" \
            --service "${SERVICE_NAME}" \
            --force-new-deployment \
            --query 'service.serviceName' \
            --output text
          
          echo "Waiting for service to stabilize..."
          aws ecs wait services-stable \
            --cluster "${CLUSTER_NAME}" \
            --services "${SERVICE_NAME}"
          
          echo "✅ Deployment completed successfully."